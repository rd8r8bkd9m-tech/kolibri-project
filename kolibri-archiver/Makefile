# Makefile for Kolibri Multi-level Archiver

CC = gcc
CFLAGS = -Wall -Wextra -O2 -std=c11
LDFLAGS = 

# Directories
SRC_DIR = src
TOOLS_DIR = tools
TESTS_DIR = tests
BIN_DIR = bin
EXAMPLES_DIR = examples

# Targets
TOOLS = $(BIN_DIR)/create_pure_formula \
        $(BIN_DIR)/restore_from_formula \
        $(BIN_DIR)/test_archive \
        $(BIN_DIR)/multilevel_archiver

OPTIONAL_TOOLS = $(BIN_DIR)/ks_compiler

TESTS = $(BIN_DIR)/test_archive_restore_demo \
        $(BIN_DIR)/test_restore_super_archive

.PHONY: all clean test tools install help

# Default target
all: dirs tools

# Create necessary directories
dirs:
	@mkdir -p $(BIN_DIR)

# Build all tools
tools: $(TOOLS)

# Build tests
tests: $(TESTS)

# Individual tool builds
$(BIN_DIR)/create_pure_formula: $(TOOLS_DIR)/create_pure_formula_archive.c
	@echo "üî® Compiling create_pure_formula..."
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)
	@echo "   ‚úì Done: $@"

$(BIN_DIR)/restore_from_formula: $(TOOLS_DIR)/restore_from_pure_formula.c
	@echo "üî® Compiling restore_from_formula..."
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)
	@echo "   ‚úì Done: $@"

$(BIN_DIR)/test_archive: $(TOOLS_DIR)/test_archive_simple.c
	@echo "üî® Compiling test_archive..."
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)
	@echo "   ‚úì Done: $@"

$(BIN_DIR)/ks_compiler: $(SRC_DIR)/ks_compiler.c
	@echo "üî® Compiling ks_compiler..."
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)
	@echo "   ‚úì Done: $@"

$(BIN_DIR)/multilevel_archiver: $(TOOLS_DIR)/create_multilevel_archive.c
	@echo "üî® Compiling multilevel_archiver..."
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)
	@echo "   ‚úì Done: $@"

# Test builds
$(BIN_DIR)/test_archive_restore_demo: $(TESTS_DIR)/test_archive_restore_demo.c
	@echo "üî® Compiling test_archive_restore_demo..."
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)
	@echo "   ‚úì Done: $@"

$(BIN_DIR)/test_restore_super_archive: $(TESTS_DIR)/test_restore_super_archive.c
	@echo "üî® Compiling test_restore_super_archive..."
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)
	@echo "   ‚úì Done: $@"

# Run all tests
test: tests
	@echo ""
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üß™ Running Tests..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo ""
	@echo "üìä Test 1: Archive Structure"
	@$(BIN_DIR)/test_archive $(EXAMPLES_DIR)/archives/kolibri_pure_formula.kolibri || true
	@echo ""
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "‚úÖ Tests completed!"
	@echo ""

# Demonstrate compression
demo: $(BIN_DIR)/create_pure_formula $(BIN_DIR)/restore_from_formula
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üé¨ Kolibri Multi-level Archiver Demo               ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üìä Step 1: Creating pure formula archive..."
	@$(BIN_DIR)/create_pure_formula
	@echo ""
	@echo "üîÑ Step 2: Restoring from formula..."
	@$(BIN_DIR)/restore_from_formula
	@echo ""
	@echo "üìà Step 3: Comparing methods..."
	@bash $(TOOLS_DIR)/compare_methods.sh
	@echo ""

# Install to system (optional)
install: all
	@echo "üì¶ Installing to /usr/local/bin..."
	@sudo cp $(BIN_DIR)/* /usr/local/bin/
	@echo "‚úÖ Installation complete!"

# Clean build artifacts
clean:
	@echo "üßπ Cleaning build artifacts..."
	@rm -rf $(BIN_DIR)
	@rm -f /tmp/kolibri_pure_formula.kolibri
	@rm -rf /tmp/restored_from_formula
	@echo "‚úÖ Clean complete!"

# Show help
help:
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  Kolibri Multi-level Archiver - Makefile Help       ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "Available targets:"
	@echo ""
	@echo "  make all          - Build all tools (default)"
	@echo "  make tools        - Build only tools"
	@echo "  make tests        - Build test programs"
	@echo "  make test         - Run all tests"
	@echo "  make demo         - Run full demonstration"
	@echo "  make install      - Install to /usr/local/bin"
	@echo "  make clean        - Remove build artifacts"
	@echo "  make help         - Show this help"
	@echo ""
	@echo "Examples:"
	@echo ""
	@echo "  # Build everything"
	@echo "  make"
	@echo ""
	@echo "  # Run demonstration"
	@echo "  make demo"
	@echo ""
	@echo "  # Build and test"
	@echo "  make all test"
	@echo ""
	@echo "Tools will be compiled to: $(BIN_DIR)/"
	@echo ""

# Show project info
info:
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üóúÔ∏è  Kolibri Multi-level Archiver                   ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üìä Statistics:"
	@echo ""
	@echo "   Source files:    $$(find $(SRC_DIR) -name '*.c' 2>/dev/null | wc -l | tr -d ' ')"
	@echo "   Header files:    $$(find $(SRC_DIR) -name '*.h' 2>/dev/null | wc -l | tr -d ' ')"
	@echo "   Tools:           $$(find $(TOOLS_DIR) -name '*.c' 2>/dev/null | wc -l | tr -d ' ')"
	@echo "   Tests:           $$(find $(TESTS_DIR) -name '*.c' 2>/dev/null | wc -l | tr -d ' ')"
	@echo "   Example archives: $$(find $(EXAMPLES_DIR) -name '*.kolibri' 2>/dev/null | wc -l | tr -d ' ')"
	@echo ""
	@echo "üèÜ Records:"
	@echo ""
	@echo "   Max compression:  377x (pure formula)"
	@echo "   Fast access:      3.34x (with associations)"
	@echo "   Restore speed:    < 1 ms"
	@echo "   Space savings:    99.7%"
	@echo ""

# Quick benchmark
benchmark: $(BIN_DIR)/restore_from_formula
	@echo ""
	@echo "‚ö° Running Quick Benchmark..."
	@echo ""
	@time $(BIN_DIR)/restore_from_formula > /dev/null 2>&1
	@echo ""
	@echo "‚úÖ Benchmark complete!"
	@echo ""
