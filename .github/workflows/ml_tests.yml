name: ML Tests

on:
  push:
    branches: [main, work]
    paths:
      - 'ml/**'
      - 'tests/ml/**'
  pull_request:
    paths:
      - 'ml/**'
      - 'tests/ml/**'

jobs:
  ml-tests:
    name: ML Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: ml/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ml/requirements.txt
          pip install pytest coverage ruff pyright
      
      - name: Lint ML code
        run: ruff check ml/
      
      - name: Type check ML code
        run: pyright ml/
        continue-on-error: true
      
      - name: Run ML tests
        run: pytest tests/ml/ -v --tb=short
      
      - name: Test coverage
        run: |
          coverage run -m pytest tests/ml/
          coverage report --include="ml/*" --fail-under=50
        continue-on-error: true

  ml-benchmark:
    name: ML Benchmark
    runs-on: ubuntu-latest
    needs: ml-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ml/requirements.txt
      
      - name: Run inference benchmark
        run: |
          python -c "
import sys
sys.path.insert(0, '.')
import numpy as np
import time
from ml.models.transformer_lite import TransformerLite
from ml.models.classifier import Classifier

# Benchmark TransformerLite
model = TransformerLite(hidden_size=64, num_layers=2, num_heads=2)
inputs = np.random.randint(0, 1000, (1, 32))

# Warmup
for _ in range(3):
    _ = model.forward(inputs)

# Benchmark
times = []
for _ in range(10):
    start = time.perf_counter()
    _ = model.forward(inputs)
    times.append((time.perf_counter() - start) * 1000)

print(f'TransformerLite (64d, 2L): {np.mean(times):.2f}ms ± {np.std(times):.2f}ms')

# Benchmark Classifier
clf = Classifier(input_dim=64, hidden_dims=[32], num_classes=10)
clf_inputs = np.random.randn(32, 64).astype(np.float32)

times = []
for _ in range(10):
    start = time.perf_counter()
    _ = clf.forward(clf_inputs)
    times.append((time.perf_counter() - start) * 1000)

print(f'Classifier (64->32->10, batch=32): {np.mean(times):.2f}ms ± {np.std(times):.2f}ms')
"
