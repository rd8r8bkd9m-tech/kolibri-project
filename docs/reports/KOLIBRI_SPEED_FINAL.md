# ‚úÖ KOLIBRI SPEED OPTIMIZATION - –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–Å–¢

## üéØ –¶–µ–ª–∏ –∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### –§–∞–∑–∞ 1: 10√ó –£–ª—É—á—à–µ–Ω–∏–µ (–î–û–°–¢–ò–ì–ù–£–¢–û ‚úÖ)
- **–ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (v3.0):** 2.83 √ó 10^8 chars/sec
- **–¶–µ–ª–µ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:** 2.83 √ó 10^9 chars/sec (10√ó)
- **–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ (v4.0):** **4.00 √ó 10^9 chars/sec**
- **–ú–Ω–æ–∂–∏—Ç–µ–ª—å:** **14.1√ó** –æ—Ç –±–∞–∑–æ–≤–æ–π

### –§–∞–∑–∞ 2: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ 5√ó –£–ª—É—á—à–µ–Ω–∏–µ
- **–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (v4.0):** 4.00 √ó 10^9 chars/sec  
- **–¶–µ–ª–µ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (v5.0):** 18.45 √ó 10^9 chars/sec (5√ó)
- **–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ø—Ä–µ–¥–µ–ª –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

## ‚úÖ v4.0: 10√ó –£–õ–£–ß–®–ï–ù–ò–ï –î–û–°–¢–ò–ì–ù–£–¢–û

### –ë–µ–Ω—á–º–∞—Ä–∫ –Ω–∞ 100 MB –¥–∞–Ω–Ω—ã—Ö

–ü—è—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç **—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ 10√ó —Ü–µ–ª–∏**:

| –ó–∞–ø—É—Å–∫ | –°–∫–æ—Ä–æ—Å—Ç—å | –ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç –±–∞–∑–æ–≤–æ–π | –ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç —Ü–µ–ª–∏ |
|--------|----------|----------------------|-------------------|
| 1 | 3.08 √ó 10^9 chars/sec | 10.9√ó | 1.09√ó |
| 2 | 3.88 √ó 10^9 chars/sec | 13.7√ó | 1.37√ó |
| 3 | 3.90 √ó 10^9 chars/sec | 13.8√ó | 1.38√ó |
| 4 | **4.00 √ó 10^9 chars/sec** | **14.1√ó** | **1.41√ó** |
| 5 | **4.00 √ó 10^9 chars/sec** | **14.1√ó** | **1.41√ó** |

**–ü–∏–∫–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:** **4.00 √ó 10^9 chars/sec**  
**–£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç –±–∞–∑–æ–≤–æ–π (2.83√ó10^8):** **14.1√ó**  
**–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Ü–µ–ª–∏ (2.83√ó10^9):** **1.41√ó**

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ v4.0

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è lookup —Ç–∞–±–ª–∏—Ü–∞**
   - –í—Å–µ 256 –±–∞–π—Ç–æ–≤ –ø—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–π –º–∞—Å—Å–∏–≤
   - –ù–µ—Ç runtime –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
   - –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∑–∞ O(1)

2. **–†–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π —Ü–∏–∫–ª (loop unrolling)**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ 16 –±–∞–π—Ç –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é
   - –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è branch overhead
   - –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –º–æ–∂–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ

3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π memcpy**
   - memcpy 3 –±–∞–π—Ç–æ–≤ –±—ã—Å—Ç—Ä–µ–µ –ø–æ–±–∞–π—Ç–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
   - –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∑–∞–º–µ–Ω—è–µ—Ç –Ω–∞ movl (1 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)

4. **–§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**
   ```bash
   gcc -O3 -march=native -funroll-loops
   ```
   - `-O3`: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
   - `-march=native`: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SIMD –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π CPU
   - `-funroll-loops`: —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–æ–≤

### –ö–æ–¥ v4.0

```c
static const char LOOKUP[256][3] = {
    {'0','0','0'}, {'0','0','1'}, ... {'2','5','5'}
};

static inline void ultra_fast_encode(const unsigned char* data, 
                                      size_t len, unsigned char* out) {
    size_t pos = 0, i = 0;
    
    // 16 –±–∞–π—Ç –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é
    for (; i + 16 <= len; i += 16) {
        memcpy(&out[pos +  0], LOOKUP[data[i + 0]], 3);
        memcpy(&out[pos +  3], LOOKUP[data[i + 1]], 3);
        // ... 14 –±–æ–ª–µ–µ memcpy
        memcpy(&out[pos + 45], LOOKUP[data[i + 15]], 3);
        pos += 48;
    }
    
    // –û—Å—Ç–∞—Ç–æ–∫
    for (; i < len; i++) {
        memcpy(&out[pos], LOOKUP[data[i]], 3);
        pos += 3;
    }
}
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π

| –í–µ—Ä—Å–∏—è | –°–∫–æ—Ä–æ—Å—Ç—å | –ú–µ—Ç–æ–¥ | –£–ª—É—á—à–µ–Ω–∏–µ |
|--------|----------|-------|-----------|
| v3.0 | 2.83 √ó 10^8 chars/sec | Runtime –¥–µ–ª–µ–Ω–∏–µ (i/100, i%100) | –±–∞–∑–æ–≤–∞—è |
| v4.0 | **4.00 √ó 10^9 chars/sec** | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è lookup + 16-byte unrolling | **14.1√ó** |
| v5.0 (–ø–æ–ø—ã—Ç–∫–∏) | 2.85 √ó 10^9 chars/sec | 128-byte unrolling | 0.71√ó (—Ä–µ–≥—Ä–µ—Å—Å–∏—è) |

## ‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è (v5.0)

### –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 1: uint32_t —É–ø–∞–∫–æ–≤–∫–∞
- **–ò–¥–µ—è:** –£–ø–∞–∫–æ–≤–∞—Ç—å 3 —Ü–∏—Ñ—Ä—ã –≤ uint32_t
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Segmentation fault (–ø—Ä–æ–±–ª–µ–º—ã —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º)
- **–°–∫–æ—Ä–æ—Å—Ç—å:** N/A

### –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 2: –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å (4 –ø–æ—Ç–æ–∫–∞)
- **–ò–¥–µ—è:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–æ–≤
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Overhead –±–æ–ª—å—à–µ –≤—ã–∏–≥—Ä—ã—à–∞
- **–°–∫–æ—Ä–æ—Å—Ç—å:** 2.07 √ó 10^9 chars/sec (0.56√ó –æ—Ç v4.0)

### –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 3: –ü—Ä—è–º—ã–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è (–±–µ–∑ memcpy)
- **–ò–¥–µ—è:** –ú–∞–∫—Ä–æ—Å—ã COPY3() –≤–º–µ—Å—Ç–æ memcpy
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–π –∫–æ–¥
- **–°–∫–æ—Ä–æ—Å—Ç—å:** 2.68 √ó 10^9 chars/sec (0.73√ó –æ—Ç v4.0)

### –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 4: –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π unrolling (128 –±–∞–π—Ç)
- **–ò–¥–µ—è:** –û–±—Ä–∞–±–æ—Ç–∫–∞ 128 –±–∞–π—Ç –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä, –∫—ç—à –ø—Ä–æ–º–∞—Ö–∏
- **–°–∫–æ—Ä–æ—Å—Ç—å:** 2.85 √ó 10^9 chars/sec (0.77√ó –æ—Ç v4.0)
- **–¢–µ—Å—Ç:** 500 MB –¥–∞–Ω–Ω—ã—Ö

## üî¨ –í—ã–≤–æ–¥

### ‚úÖ 10√ó –£–ª—É—á—à–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ!

**v4.0 —è–≤–ª—è–µ—Ç—Å—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π** –¥–ª—è C-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –∞—Å—Å–µ–º–±–ª–µ—Ä–∞:
- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è lookup —Ç–∞–±–ª–∏—Ü–∞ (—Å–∞–º–æ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ)
- 16-byte unrolling (–±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ä–∞–∑–º–µ—Ä–æ–º –∏ —Å–∫–æ—Ä–æ—Å—Ç—å—é)
- memcpy 3 –±–∞–π—Ç–∞ (–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –≤ 1 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é)

**–°–∫–æ—Ä–æ—Å—Ç—å 4.00 √ó 10^9 chars/sec –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ü–µ–ª—å –Ω–∞ 41%!**

### üöß –î–ª—è 5√ó —É–ª—É—á—à–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è:

1. **SIMD –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (AVX2/AVX-512)**
   - –†—É—á–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ intrinsics
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ 32-64 –±–∞–π—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
   - –û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç: 2-4√ó

2. **–ê—Å—Å–µ–º–±–ª–µ—Ä–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
   - –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
   - –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è memory load/store
   - –û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç: 3-6√ó

3. **GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ**
   - CUDA/Metal kernels
   - –ú–∞—Å—Å–æ–≤–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è
   - –û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç: 10-100√ó

**–¢–µ–∫—É—â–∞—è C-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∏–≥–ª–∞ –ø—Ä–µ–¥–µ–ª–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π.**

## ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å

–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ –≤—Å–µ—Ö –≤–µ—Ä—Å–∏—è—Ö:

```
–í—Ö–æ–¥–Ω—ã–µ –±–∞–π—Ç—ã: 41 41 41 (hex) = "AAA"
–í—ã—Ö–æ–¥ (—Ü–∏—Ñ—Ä—ã): 065065065
–û–∂–∏–¥–∞–µ—Ç—Å—è:     065065065
‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ!
```

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

–≠—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –ø–æ–ª–Ω—ã–π –∞—Ä—Ö–∏–≤–∞—Ç–æ—Ä v3.0:

1. –ó–∞–º–µ–Ω–∏—Ç—å `byte_to_3digits()` –Ω–∞ `ultra_fast_encode()`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é LOOKUP —Ç–∞–±–ª–∏—Ü—É
3. –ö–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å —Å —Ñ–ª–∞–≥–∞–º–∏ `-O3 -march=native -funroll-loops`

**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –æ–±—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–∂–∞—Ç–∏—è:** ~10-14√ó –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

## üìù –ò—Ç–æ–≥–∏

‚úÖ **–¶–µ–ª—å 10√ó –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞:** 4.00 √ó 10^9 chars/sec (14.1√ó –æ—Ç –±–∞–∑–æ–≤–æ–π)  
‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ü–∏–∫–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ 2+ –∑–∞–ø—É—Å–∫–∞—Ö  
‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å:** –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ  
‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ø—Ä–µ–¥–µ–ª –¥–ª—è C –±–µ–∑ –∞—Å—Å–µ–º–±–ª–µ—Ä–∞  
‚ö†Ô∏è **–¶–µ–ª—å 5√ó (18.45 √ó 10^9):** –¢—Ä–µ–±—É–µ—Ç SIMD/–∞—Å—Å–µ–º–±–ª–µ—Ä–∞

**–ú–µ—Ç–æ–¥ "—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è lookup + –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π unrolling" —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω** —á–µ—Ä–µ–∑:
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö runtime –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ lookup —Ç–∞–±–ª–∏—Ü—ã
- –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–æ–≤ (16 –±–∞–π—Ç - –æ–ø—Ç–∏–º—É–º)
- –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (-O3 -march=native)

---

**–§–∞–π–ª—ã:**
- –ò—Å—Ö–æ–¥–Ω–∏–∫ v4.0: `tools/kolibri_fast.c` ‚≠ê –û–ü–¢–ò–ú–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø
- –ò—Å—Ö–æ–¥–Ω–∏–∫ v5.0 (–ø–æ–ø—ã—Ç–∫–∏): `tools/kolibri_turbo.c`, `kolibri_hyper.c`, `kolibri_ultra.c`
- –ë–∏–Ω–∞—Ä–Ω–∏–∫: `tools/kolibri-fast`
- –ö–æ–º–∞–Ω–¥–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: `gcc -O3 -march=native -funroll-loops -o kolibri-fast kolibri_fast.c`
- –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞: `./kolibri-fast`

**–î–∞—Ç–∞:** 13 –Ω–æ—è–±—Ä—è 2024  
**–°–∏—Å—Ç–µ–º–∞:** macOS ARM64 (M-series)  
**–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ:** 14.1√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ ‚úÖ
